<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Two Little Bees ‚Äî Parts Inventory</title>
  <meta name="color-scheme" content="dark">
  <meta name="theme-color" content="#0b0f14">

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f172a;
      --panel2:#0b1220;
      --card:#0e1726;
      --text:#f9fafb;
      --muted:#9ca3af;
      --border:rgba(255,255,255,.10);
      --accent:#f4c430;
      --accent2:#ffb703;
      --danger:#ff4d4d;
      --ok:#22c55e;
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 20% 10%, rgba(244,196,48,.10), transparent 60%),
                  radial-gradient(1200px 800px at 80% 0%, rgba(255,183,3,.08), transparent 60%),
                  var(--bg);
      color:var(--text);
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    a{color:inherit}
    .wrap{max-width:1200px;margin:24px auto;padding:0 14px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:22px;
      padding:12px 14px;
      box-shadow: var(--shadow);
      position:sticky;top:10px;z-index:50;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:center;gap:10px;min-width:220px}
    .bee{
      width:34px;height:34px;border-radius:10px;
      background:linear-gradient(135deg, rgba(244,196,48,.9), rgba(255,183,3,.75));
      box-shadow: 0 12px 30px rgba(244,196,48,.18);
    }
    .brand h1{font-size:14px;margin:0}
    .brand small{display:block;color:var(--muted);margin-top:2px}
    .navbtns{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      color:var(--text);
      padding:9px 12px;border-radius:14px;
      cursor:pointer;
      display:inline-flex;align-items:center;gap:8px;
      transition:.15s ease;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.18)}
    .btn.primary{
      border-color:rgba(244,196,48,.55);
      background:rgba(244,196,48,.12);
    }
    .btn.danger{
      border-color:rgba(255,77,77,.45);
      background:rgba(255,77,77,.10);
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:99px;background:var(--ok)}
    .dot.off{background:rgba(255,255,255,.30)}
    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
      margin-top:14px;
    }
    @media(max-width:980px){ .grid{grid-template-columns:1fr} .brand{min-width:auto}}
    .panel{
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .panel h2{margin:0 0 8px 0;font-size:16px}
    .sub{color:var(--muted);margin:0 0 12px 0}
    .controls{
      display:grid;grid-template-columns:1.2fr .8fr .8fr .8fr;
      gap:10px;
    }
    @media(max-width:980px){
      .controls{grid-template-columns:1fr 1fr}
    }
    .field label{display:block;color:var(--muted);font-size:12px;margin:0 0 6px 2px}
    .input, select, textarea{
      width:100%;
      background:rgba(0,0,0,.25);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      outline:none;
    }
    textarea{min-height:90px;resize:vertical}
    .row{
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .stats{display:flex;gap:10px;flex-wrap:wrap}
    .stat{
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      border-radius:16px;
      padding:10px 12px;
      min-width:150px;
    }
    .stat b{display:block;font-size:16px}
    .stat span{color:var(--muted);font-size:12px}
    .tableWrap{margin-top:12px}
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    thead th{
      color:var(--muted);
      font-weight:600;
      text-align:left;
      font-size:12px;
      padding:0 10px;
      white-space:nowrap;
    }
    tbody tr{
      background:rgba(0,0,0,.20);
      border:1px solid var(--border);
    }
    tbody td{
      padding:12px 10px;
      border-top:1px solid var(--border);
      border-bottom:1px solid var(--border);
      vertical-align:top;
    }
    tbody tr td:first-child{
      border-left:1px solid var(--border);
      border-top-left-radius:16px;border-bottom-left-radius:16px
    }
    tbody tr td:last-child{
      border-right:1px solid var(--border);
      border-top-right-radius:16px;border-bottom-right-radius:16px
    }
    .thumb{
      width:54px;height:54px;border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      object-fit:cover;
    }
    .muted{color:var(--muted)}
    .fit{white-space:nowrap}
    .price{font-weight:800}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .cards{display:none; margin-top:10px; gap:10px}
    .card{
      border:1px solid var(--border);
      background:rgba(0,0,0,.20);
      border-radius:18px;
      padding:12px;
      display:grid;
      grid-template-columns: 66px 1fr;
      gap:12px;
    }
    .card h3{margin:0 0 2px 0;font-size:14px}
    .card .meta{color:var(--muted);font-size:12px}
    .card .line{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    @media(max-width:780px){
      .tableWrap{display:none}
      .cards{display:grid}
    }
    .modalBack{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;
      padding:16px;z-index:100;
    }
    .modal{
      width:min(900px, 100%);
      border-radius:22px;
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(15,23,42,.98), rgba(11,18,32,.98));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:14px 14px;border-bottom:1px solid var(--border);
    }
    .modalHead b{font-size:14px}
    .x{
      width:38px;height:38px;border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer;
    }
    .modalBody{padding:14px}
    .formGrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media(max-width:860px){ .formGrid{grid-template-columns:1fr} }
    .modalFoot{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:14px;border-top:1px solid var(--border);
      flex-wrap:wrap;
    }
    .hint{color:var(--muted);font-size:12px}
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(0,0,0,.72);
      border:1px solid var(--border);
      padding:10px 12px;border-radius:14px;
      color:var(--text);
      display:none;
      z-index:200;
      max-width:min(640px, calc(100% - 24px));
    }
    .footer{
      margin:18px 0 28px;
      color:var(--muted);
      text-align:center;
      font-size:12px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="bee" aria-hidden="true"></div>
        <div>
          <h1>Two Little Bees ‚Äî Parts Inventory</h1>
          <small>Search ‚Ä¢ Fitment ‚Ä¢ Warranty ‚Ä¢ Pricing</small>
        </div>
      </div>

      <div class="navbtns">
        <span class="pill" title="Firebase status">
          <span id="liveDot" class="dot off"></span>
          <span id="liveText">Connecting‚Ä¶</span>
        </span>
        <span class="pill" id="adminPill">
          <span id="adminDot" class="dot off"></span>
          <span id="adminText">Not signed in</span>
        </span>

        <!-- ‚úÖ NAV FIXED (no more 404 guessing) -->
        <button class="btn" onclick="window.location.href='./index.html'">‚¨ÖÔ∏è Landing</button>
<button class="btn" onclick="window.location.href='https://twolittlebeesautoaparts.github.io/'">üöó Cars</button>

       
        <button class="btn primary" id="adminBtn" style="display:none" onclick="openPartModal()">‚ûï Add Part</button>
        <button class="btn" id="loginBtn" onclick="openAuthModal()">üîê Login</button>
        <button class="btn danger" id="logoutBtn" style="display:none" onclick="doLogout()">üö™ Logout</button>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <h2>Find Parts Fast</h2>
        <p class="sub">Search includes part + notes + interchange + vehicle fitment (year/make/model/trim/engine).</p>

        <div class="controls">
          <div class="field">
            <label>Search</label>
            <input id="q" class="input" placeholder="Search: engine, alternator, Jeep, 2015, renegade, 2.4, stock id‚Ä¶" />
          </div>
          <div class="field">
            <label>Category</label>
            <select id="cat">
              <option value="">All</option>
              <option>Engine</option>
              <option>Transmission</option>
              <option>Body Panel</option>
              <option>Body Part</option>
              <option>Wheel</option>
              <option>Battery</option>
              <option>Drivetrain</option>
              <option>Module</option>
              <option>Other</option>
            </select>
          </div>
          <div class="field">
            <label>Condition</label>
            <select id="cond">
              <option value="">All</option>
              <option>Used</option>
              <option>New</option>
              <option>Refurbished</option>
              <option>Core</option>
            </select>
          </div>
          <div class="field">
            <label>Sort</label>
            <select id="sort">
              <option value="newest">Newest</option>
              <option value="oldest">Oldest</option>
              <option value="priceHigh">Price: High ‚Üí Low</option>
              <option value="priceLow">Price: Low ‚Üí High</option>
              <option value="nameAZ">Name A ‚Üí Z</option>
              <option value="nameZA">Name Z ‚Üí A</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="stats">
            <div class="stat"><b id="statCount">0</b><span>Matching parts</span></div>
            <div class="stat"><b id="statTotal">0</b><span>Total parts</span></div>
            <div class="stat"><b id="statAvg">$0</b><span>Avg price</span></div>
          </div>

          <div class="actions">
            <button class="btn" onclick="clearFilters()">üßπ Clear</button>
            <button class="btn" onclick="refreshData()">üîÑ Refresh</button>
          </div>
        </div>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Image</th>
                <th>Part</th>
                <th>Category</th>
                <th>Condition</th>
                <th>Vehicle Fitment</th>
                <th>Price</th>
                <th>Stock / Location</th>
                <th>Warranty</th>
                <th>Admin</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
          <div class="hint">Tip: Mobile shows cards (no side scroll). Desktop shows table.</div>
        </div>

        <div class="cards" id="cards"></div>
      </div>

      <div class="panel">
        <h2>Quick Admin Tips</h2>
        <p class="sub">
          ‚úÖ Add parts with fitment fields so search works better. <br/>
          üì∏ For images, paste an Image URL (Facebook, Imgur, your site, etc.). <br/>
          üîê Only your admin email can write after rules lock.
        </p>

        <div class="field">
          <label>Suggested Stock Format</label>
          <input class="input" value="BEE-000123" readonly />
        </div>

        <div class="field" style="margin-top:10px">
          <label>Suggested Location Format</label>
          <input class="input" value="Row 3 / Shelf B / Car #12" readonly />
        </div>

        <div class="field" style="margin-top:10px">
          <label>Note Example</label>
          <textarea readonly>Tested good. Include harness. Minor scratches. Interchange confirmed.</textarea>
        </div>
      </div>
    </div>

    <div class="footer">
      Hablamos Espa√±ol ‚Ä¢ Call: (317) 243-7777 ‚Ä¢ 507 S Tibbs Ave, Indianapolis
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="modalBack" id="authBack">
    <div class="modal">
      <div class="modalHead">
        <b>Admin Login</b>
        <button class="x" onclick="closeAuthModal()">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="formGrid">
          <div class="field">
            <label>Email</label>
            <input id="authEmail" class="input" placeholder="you@email.com" />
          </div>
          <div class="field">
            <label>Password</label>
            <input id="authPass" class="input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          </div>
        </div>
        <p class="hint" style="margin-top:10px">
          If you don‚Äôt have an account yet, click ‚ÄúCreate account‚Äù once, then login normally.
        </p>
      </div>
      <div class="modalFoot">
        <span class="hint" id="authHint">Only approved admin emails can write.</span>
        <div class="actions">
          <button class="btn" onclick="signup()">Create account</button>
          <button class="btn primary" onclick="login()">Login</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modalBack" id="partBack">
    <div class="modal">
      <div class="modalHead">
        <b id="partTitle">Add Part</b>
        <button class="x" onclick="closePartModal()">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="formGrid">
          <div class="field">
            <label>Part Name *</label>
            <input id="p_name" class="input" placeholder="Engine, Transmission, Alternator‚Ä¶" />
          </div>
          <div class="field">
            <label>Category *</label>
            <select id="p_category">
              <option>Engine</option>
              <option>Transmission</option>
              <option>Body Panel</option>
              <option>Body Part</option>
              <option>Wheel</option>
              <option>Battery</option>
              <option>Drivetrain</option>
              <option>Module</option>
              <option>Other</option>
            </select>
          </div>

          <div class="field">
            <label>Condition</label>
            <select id="p_condition">
              <option>Used</option>
              <option>New</option>
              <option>Refurbished</option>
              <option>Core</option>
            </select>
          </div>
          <div class="field">
            <label>Warranty</label>
            <select id="p_warranty">
              <option>30-day start-up warranty ‚Ä¢ exchange only</option>
              <option>14-day exchange only</option>
              <option>No warranty</option>
            </select>
          </div>

          <div class="field">
            <label>Vehicle Year</label>
            <input id="p_year" class="input" placeholder="2015" />
          </div>
          <div class="field">
            <label>Vehicle Make</label>
            <input id="p_make" class="input" placeholder="Jeep" />
          </div>
          <div class="field">
            <label>Vehicle Model</label>
            <input id="p_model" class="input" placeholder="Renegade" />
          </div>
          <div class="field">
            <label>Vehicle Trim</label>
            <input id="p_trim" class="input" placeholder="Latitude / Sport / LX‚Ä¶" />
          </div>

          <div class="field">
            <label>Vehicle Engine</label>
            <input id="p_engine" class="input" placeholder="2.4L" />
          </div>
          <div class="field">
            <label>Price (USD) *</label>
            <input id="p_price" class="input" placeholder="800" inputmode="decimal" />
          </div>

          <div class="field">
            <label>Interchange</label>
            <input id="p_interchange" class="input" placeholder="Part #, Hollander #, etc" />
          </div>
          <div class="field">
            <label>Stock / Tag ID</label>
            <input id="p_stock" class="input" placeholder="BEE-01821" />
          </div>

          <div class="field">
            <label>Location</label>
            <input id="p_location" class="input" placeholder="Row 3 / Shelf B / Car #12" />
          </div>
          <div class="field">
            <label>Image URL</label>
            <input id="p_imageUrl" class="input" placeholder="https://‚Ä¶" />
          </div>

          <div class="field" style="grid-column:1/-1">
            <label>Notes</label>
            <textarea id="p_notes" placeholder="Tested good. Minor scratches. Include harness‚Ä¶"></textarea>
          </div>
        </div>
        <div class="hint" style="margin-top:10px">
          * Required fields. Saving writes into Firestore collection: <b>parts</b>.
        </div>
      </div>
      <div class="modalFoot">
        <button class="btn" onclick="resetPartForm()">Reset</button>
        <div class="actions">
          <button class="btn danger" id="deleteBtn" style="display:none" onclick="deleteCurrent()">Delete</button>
          <button class="btn primary" onclick="savePart()">Save</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   0) CONFIG ‚Äî YOUR REAL ONE
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyBVumo8QP3m18p33ugqx_eNADsjHG0gJS0",
  authDomain: "two-little-bees-inventory.firebaseapp.com",
  projectId: "two-little-bees-inventory",
  storageBucket: "two-little-bees-inventory.appspot.com",
  messagingSenderId: "669354511397",
  appId: "1:669354511397:web:a5e4565496e097f85483cc",
  measurementId: "G-736B95M78E"
};

/* =========================
   1) INIT
========================= */
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ‚úÖ normalize admin emails to lowercase so matching is reliable */
const ADMIN_EMAILS = [
  "josueblas971@gmail.com"
].map(e => String(e).toLowerCase());

const partsCol = db.collection("parts");

/* =========================
   2) STATE
========================= */
let ALL = [];
let isAdmin = false;
let editingId = null;

/* =========================
   3) UI HELPERS
========================= */
const el = id => document.getElementById(id);

function toast(msg){
  const t = el("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(()=> t.style.display="none", 2600);
}

function setLive(ok){
  el("liveDot").className = "dot" + (ok ? "" : " off");
  el("liveText").textContent = ok ? "Live ‚Ä¢ Firestore" : "Offline";
}

function setAdminUI(){
  el("adminDot").className = "dot" + (isAdmin ? "" : " off");
  el("adminText").textContent = isAdmin ? "Admin mode" : (auth.currentUser ? "Signed in (no write)" : "Not signed in");
  el("adminBtn").style.display = isAdmin ? "inline-flex" : "none";
  el("logoutBtn").style.display = auth.currentUser ? "inline-flex" : "none";
  el("loginBtn").style.display = auth.currentUser ? "none" : "inline-flex";
}

/* =========================
   ‚úÖ NAV FIX (GitHub Pages safe)
========================= */
function goLanding(){
  // always go to the site root (works from /OFFICIALPAGE/* too)
  window.location.href = window.location.origin + "/";
}

async function goCars(){
  // tries common names in the SAME folder as this page
  const candidates = ["cars.html", "car.html", "Cars.html", "CARS.html"];
  const baseUrl = new URL(".", window.location.href);

  for (const name of candidates){
    const target = new URL(name, baseUrl).toString();
    try{
      const res = await fetch(target, { method: "HEAD", cache: "no-store" });
      if (res.ok){
        window.location.href = target;
        return;
      }
    } catch (e) {}
  }

  toast("Cars page not found. Check filename/case in OFFICIALPAGE (cars.html / car.html).");
}

/* =========================
   4) AUTH
========================= */
function openAuthModal(){ el("authBack").style.display="flex"; }
function closeAuthModal(){ el("authBack").style.display="none"; }

async function signup(){
  const email = el("authEmail").value.trim();
  const pass = el("authPass").value;
  if(!email || !pass) return toast("Enter email + password.");
  try{
    await auth.createUserWithEmailAndPassword(email, pass);
    toast("Account created. Now you can login.");
    closeAuthModal();
  }catch(e){
    toast(e.message || "Signup failed.");
  }
}

async function login(){
  const email = el("authEmail").value.trim();
  const pass = el("authPass").value;
  if(!email || !pass) return toast("Enter email + password.");
  try{
    await auth.signInWithEmailAndPassword(email, pass);
    toast("Logged in.");
    closeAuthModal();
  }catch(e){
    toast(e.message || "Login failed.");
  }
}

async function doLogout(){
  await auth.signOut();
  toast("Logged out.");
}

/* =========================
   5) FETCH / RENDER
========================= */
function normalizeStr(x){
  return String(x ?? "").toLowerCase();
}
function matchQuery(p, q){
  if(!q) return true;
  const hay = [
    p.name, p.category, p.condition, p.notes, p.interchange,
    p.vehicleYear, p.vehicleMake, p.vehicleModel, p.vehicleTrim, p.vehicleEngine,
    p.stock, p.location, p.warranty
  ].map(normalizeStr).join(" ");
  return hay.includes(q);
}

function applyFilters(list){
  const q = normalizeStr(el("q").value.trim());
  const cat = el("cat").value.trim();
  const cond = el("cond").value.trim();
  let out = list.filter(p => {
    if(cat && String(p.category||"") !== cat) return false;
    if(cond && String(p.condition||"") !== cond) return false;
    if(!matchQuery(p, q)) return false;
    return true;
  });

  const sort = el("sort").value;
  const byName = (a,b)=> (String(a.name||"")).localeCompare(String(b.name||""));
  const byCreated = (a,b)=> (Number(a._created||0) - Number(b._created||0));
  const byPrice = (a,b)=> (Number(a.price||0) - Number(b.price||0));

  if(sort==="newest") out.sort((a,b)=> byCreated(b,a));
  if(sort==="oldest") out.sort(byCreated);
  if(sort==="priceHigh") out.sort((a,b)=> byPrice(b,a));
  if(sort==="priceLow") out.sort(byPrice);
  if(sort==="nameAZ") out.sort(byName);
  if(sort==="nameZA") out.sort((a,b)=> byName(b,a));

  return out;
}

function money(n){
  const x = Number(n||0);
  return "$" + x.toFixed(0);
}

function fitment(p){
  const y = p.vehicleYear ? String(p.vehicleYear) : "";
  const mk = p.vehicleMake ? String(p.vehicleMake) : "";
  const md = p.vehicleModel ? String(p.vehicleModel) : "";
  const tr = p.vehicleTrim ? String(p.vehicleTrim) : "";
  const eg = p.vehicleEngine ? String(p.vehicleEngine) : "";
  const s = [y,mk,md,tr,eg].filter(Boolean).join(" ");
  return s || "‚Äî";
}

function safeText(x){ return (x==null? "" : String(x)); }

function render(){
  const filtered = applyFilters(ALL);

  el("statCount").textContent = filtered.length;
  el("statTotal").textContent = ALL.length;
  const avg = filtered.length ? filtered.reduce((a,p)=>a+Number(p.price||0),0)/filtered.length : 0;
  el("statAvg").textContent = "$" + Math.round(avg);

  const rows = filtered.map(p=>{
    const img = p.imageUrl ? `<img class="thumb" src="${p.imageUrl}" onerror="this.style.opacity=.25;this.src='';" />`
                           : `<div class="thumb" style="display:grid;place-items:center;color:rgba(255,255,255,.35)">‚Äî</div>`;
    const adminActions = isAdmin
      ? `<div class="actions">
           <button class="btn" onclick="editPart('${p.id}')">‚úèÔ∏è Edit</button>
           <button class="btn danger" onclick="confirmDelete('${p.id}')">üóë Delete</button>
         </div>`
      : `<span class="muted">‚Äî</span>`;

    return `
      <tr>
        <td>${img}</td>
        <td>
          <b>${safeText(p.name)}</b><div class="muted">${safeText(p.notes).slice(0,80)}${safeText(p.notes).length>80?'‚Ä¶':''}</div>
          ${p.interchange ? `<div class="tag">üîÅ ${safeText(p.interchange)}</div>` : ""}
        </td>
        <td><span class="tag">${safeText(p.category)||"‚Äî"}</span></td>
        <td><span class="tag">${safeText(p.condition)||"‚Äî"}</span></td>
        <td class="fit">${fitment(p)}</td>
        <td class="price">${money(p.price)}</td>
        <td>
          <div><b>${safeText(p.stock)||"‚Äî"}</b></div>
          <div class="muted">${safeText(p.location)||"‚Äî"}</div>
        </td>
        <td>${safeText(p.warranty)||"‚Äî"}</td>
        <td>${adminActions}</td>
      </tr>
    `;
  }).join("");

  el("rows").innerHTML = rows || `
    <tr><td colspan="9" class="muted" style="padding:16px">No parts match your search.</td></tr>
  `;

  el("cards").innerHTML = filtered.map(p=>{
    const img = p.imageUrl ? `<img class="thumb" src="${p.imageUrl}" onerror="this.style.opacity=.25;this.src='';" />`
                           : `<div class="thumb" style="display:grid;place-items:center;color:rgba(255,255,255,.35)">‚Äî</div>`;
    const actions = isAdmin
      ? `<div class="actions" style="margin-top:10px">
           <button class="btn" onclick="editPart('${p.id}')">‚úèÔ∏è Edit</button>
           <button class="btn danger" onclick="confirmDelete('${p.id}')">üóë Delete</button>
         </div>`
      : "";

    return `
      <div class="card">
        ${img}
        <div>
          <h3>${safeText(p.name)}</h3>
          <div class="meta">${safeText(p.category)||"‚Äî"} ‚Ä¢ ${safeText(p.condition)||"‚Äî"} ‚Ä¢ <b>${money(p.price)}</b></div>
          <div class="line">
            <span class="tag">üöó ${fitment(p)}</span>
            <span class="tag">üè∑ ${safeText(p.stock)||"‚Äî"}</span>
            <span class="tag">üìç ${safeText(p.location)||"‚Äî"}</span>
          </div>
          ${p.notes ? `<div class="meta" style="margin-top:8px">${safeText(p.notes)}</div>` : ""}
          ${actions}
        </div>
      </div>
    `;
  }).join("");
}

async function refreshData(){
  try{
    setLive(true);
    const snap = await partsCol.get();
    ALL = snap.docs.map(d=>{
      const data = d.data() || {};
      const created = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate().getTime() : 0;
      return { id:d.id, ...data, _created: created };
    });
    render();
    toast("Loaded parts.");
  }catch(e){
    setLive(false);
    toast(e.message || "Load failed.");
  }
}

/* =========================
   6) FILTER EVENTS
========================= */
["q","cat","cond","sort"].forEach(id=>{
  const node = el(id);
  node.addEventListener("input", render);
  node.addEventListener("change", render);
});
function clearFilters(){
  el("q").value = "";
  el("cat").value = "";
  el("cond").value = "";
  el("sort").value = "newest";
  render();
}

/* =========================
   7) ADD / EDIT / DELETE
========================= */
function openPartModal(){
  if(!isAdmin) return toast("Login as admin first.");
  el("partBack").style.display = "flex";
}
function closePartModal(){
  el("partBack").style.display = "none";
  editingId = null;
  el("deleteBtn").style.display="none";
  el("partTitle").textContent = "Add Part";
}
function resetPartForm(){
  const ids = ["p_name","p_year","p_make","p_model","p_trim","p_engine","p_price","p_interchange","p_stock","p_location","p_notes","p_imageUrl"];
  ids.forEach(x=> el(x).value = "");
  el("p_category").value = "Engine";
  el("p_condition").value = "Used";
  el("p_warranty").value = "30-day start-up warranty ‚Ä¢ exchange only";
}

function fillPartForm(p){
  el("p_name").value = p.name || "";
  el("p_category").value = p.category || "Engine";
  el("p_condition").value = p.condition || "Used";
  el("p_warranty").value = p.warranty || "30-day start-up warranty ‚Ä¢ exchange only";
  el("p_year").value = p.vehicleYear || "";
  el("p_make").value = p.vehicleMake || "";
  el("p_model").value = p.vehicleModel || "";
  el("p_trim").value = p.vehicleTrim || "";
  el("p_engine").value = p.vehicleEngine || "";
  el("p_price").value = (p.price ?? "");
  el("p_interchange").value = p.interchange || "";
  el("p_stock").value = p.stock || "";
  el("p_location").value = p.location || "";
  el("p_notes").value = p.notes || "";
  el("p_imageUrl").value = p.imageUrl || "";
}

function getPartPayload(){
  const name = el("p_name").value.trim();
  const category = el("p_category").value.trim();
  const price = Number(el("p_price").value);
  if(!name) throw new Error("Part name is required.");
  if(!category) throw new Error("Category is required.");
  if(!Number.isFinite(price)) throw new Error("Price must be a number.");

  return {
    name,
    category,
    condition: el("p_condition").value.trim(),
    warranty: el("p_warranty").value.trim(),
    vehicleYear: el("p_year").value.trim(),
    vehicleMake: el("p_make").value.trim(),
    vehicleModel: el("p_model").value.trim(),
    vehicleTrim: el("p_trim").value.trim(),
    vehicleEngine: el("p_engine").value.trim(),
    interchange: el("p_interchange").value.trim(),
    stock: el("p_stock").value.trim(),
    location: el("p_location").value.trim(),
    notes: el("p_notes").value.trim(),
    imageUrl: el("p_imageUrl").value.trim(),
    price: price
  };
}

async function savePart(){
  if(!isAdmin) return toast("Login as admin first.");
  try{
    const payload = getPartPayload();
    payload.updatedAt = firebase.firestore.FieldValue.serverTimestamp();

    if(editingId){
      await partsCol.doc(editingId).update(payload);
      toast("Updated.");
    }else{
      payload.createdAt = firebase.firestore.FieldValue.serverTimestamp();
      await partsCol.add(payload);
      toast("Saved.");
    }
    closePartModal();
    await refreshData();
  }catch(e){
    toast(e.message || "Save failed.");
  }
}

function editPart(id){
  if(!isAdmin) return toast("Login as admin first.");
  const p = ALL.find(x=>x.id===id);
  if(!p) return toast("Part not found.");
  editingId = id;
  el("partTitle").textContent = "Edit Part";
  el("deleteBtn").style.display="inline-flex";
  fillPartForm(p);
  openPartModal();
}

function confirmDelete(id){
  if(!isAdmin) return toast("Login as admin first.");
  const p = ALL.find(x=>x.id===id);
  if(!p) return toast("Part not found.");
  if(confirm(`Delete "${p.name}"? This cannot be undone.`)){
    partsCol.doc(id).delete()
      .then(()=>{ toast("Deleted."); refreshData(); })
      .catch(e=> toast(e.message || "Delete failed."));
  }
}

async function deleteCurrent(){
  if(!editingId) return;
  confirmDelete(editingId);
  closePartModal();
}

/* =========================
   8) AUTH STATE + BOOT
========================= */
auth.onAuthStateChanged(async (user)=>{
  const email = (user?.email || "").toLowerCase();
  isAdmin = !!(user && ADMIN_EMAILS.includes(email));
  setAdminUI();
  if(user && !isAdmin){
    toast("Signed in, but not an admin email.");
  }
});

(async function boot(){
  try{
    await db.enablePersistence({ synchronizeTabs:true }).catch(()=>{});
    setLive(true);
  }catch(e){
    setLive(false);
  }
  resetPartForm();
  await refreshData();
})();
</script>
</body>
</html>
